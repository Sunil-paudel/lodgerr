module.exports = {

"[project]/.next-internal/server/app/api/bookings/initiate-payment/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/@opentelemetry/api [external] (@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@opentelemetry/api", () => require("@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/assert [external] (assert, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}}),
"[externals]/querystring [external] (querystring, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/child_process [external] (child_process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}}),
"[externals]/mongoose [external] (mongoose, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("mongoose", () => require("mongoose"));

module.exports = mod;
}}),
"[project]/src/utils/db.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "default": (()=>__TURBOPACK__default__export__)
});
var __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/mongoose [external] (mongoose, cjs)");
;
__TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].set('strictQuery', false);
// Ensure this MONGODB_URL is correct and your IP is whitelisted if using Atlas.
const MONGODB_URL = "mongodb+srv://paudelsunil16:paudelsunil16@cluster0.dlua3bq.mongodb.net/";
const connectDB = async ()=>{
    if (__TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].connection.readyState >= 1) {
        console.log("MongoDB is already connected.");
        return;
    }
    try {
        if ("TURBOPACK compile-time falsy", 0) {
            "TURBOPACK unreachable";
        }
        console.log("[DB Connect] Attempting to connect to MongoDB...");
        await __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].connect(MONGODB_URL);
        console.log("[DB Connect] MongoDB connected successfully.");
    } catch (error) {
        console.error("[DB Connect] MongoDB connection failed:", error.message);
        if (error.stack) {
            console.error("[DB Connect] MongoDB connection error stack:", error.stack);
        } else {
            console.error("[DB Connect] MongoDB connection error details:", error);
        }
        // Construct a new error to ensure it's an Error instance with a clear message
        throw new Error("Database connection failed: " + error.message);
    }
};
const __TURBOPACK__default__export__ = connectDB;
}}),
"[project]/src/models/User.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "default": (()=>__TURBOPACK__default__export__)
});
var __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/mongoose [external] (mongoose, cjs)");
;
const userSchema = new __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["Schema"]({
    name: {
        type: String,
        required: true
    },
    email: {
        type: String,
        required: true,
        unique: true
    },
    passwordHash: {
        type: String
    },
    role: {
        type: String,
        enum: [
            "guest",
            "host",
            "admin"
        ],
        default: "guest"
    },
    stripeAccountId: {
        type: String
    },
    avatarUrl: {
        type: String
    }
}, {
    timestamps: true,
    toJSON: {
        virtuals: true,
        transform: function(doc, ret) {
            ret.id = ret._id.toString(); // map _id to id
            delete ret._id;
            delete ret.passwordHash; // remove passwordHash
            delete ret.__v; // remove __v
        }
    },
    toObject: {
        virtuals: true,
        transform: function(doc, ret) {
            ret.id = ret._id.toString();
            delete ret._id;
            delete ret.passwordHash;
            delete ret.__v;
        }
    }
});
const __TURBOPACK__default__export__ = __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].models.User || __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].model("User", userSchema);
}}),
"[project]/src/app/api/auth/[...nextauth]/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>handler),
    "POST": (()=>handler),
    "authOptions": (()=>authOptions)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$credentials$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/providers/credentials.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$bcryptjs$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/bcryptjs/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$utils$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/utils/db.ts [app-route] (ecmascript)"); // MongoDB connection utility
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$User$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/models/User.ts [app-route] (ecmascript)"); // Mongoose User model
;
;
;
;
;
// Check for NEXTAUTH_SECRET at module load time
if (!process.env.NEXTAUTH_SECRET) {
    console.warn("\x1b[33m%s\x1b[0m", "[NextAuth Warning] NEXTAUTH_SECRET environment variable is not set! " + "Authentication will not work reliably. Please ensure it is set in your environment.");
}
const authOptions = {
    // === Authentication Providers ===
    providers: [
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$credentials$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
            id: "credentials",
            name: "Credentials",
            // Fields for sign-in formx
            credentials: {
                email: {
                    label: "Email",
                    type: "text",
                    placeholder: "jsmith@example.com"
                },
                password: {
                    label: "Password",
                    type: "password"
                }
            },
            // Core login logic
            async authorize (credentials) {
                console.log("[Authorize] Credentials received:", credentials ? {
                    email: credentials.email,
                    password_exists: !!credentials.password
                } : "null_credentials");
                // Validate input
                if (!credentials?.email || !credentials?.password) {
                    console.log("[Authorize] Missing email or password.");
                    throw new Error("Please enter both email and password.");
                }
                try {
                    console.log("[Authorize] Connecting to DB...");
                    await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$utils$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])();
                    console.log("[Authorize] DB connection successful.");
                    const user = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$User$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].findOne({
                        email: credentials.email
                    });
                    if (!user) {
                        console.log("[Authorize] No user found with email:", credentials.email);
                        throw new Error("No user found with this email.");
                    }
                    if (!user.passwordHash) {
                        console.log("[Authorize] User has no password set:", credentials.email);
                        throw new Error("User account is not properly configured for password login.");
                    }
                    const isValidPassword = await __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$bcryptjs$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].compare(credentials.password, user.passwordHash);
                    if (!isValidPassword) {
                        console.log("[Authorize] Incorrect password for:", credentials.email);
                        throw new Error("Invalid password.");
                    }
                    // Success: Return user data matching the `User` interface in next-auth.d.ts
                    console.log("[Authorize] Login success for user:", user._id.toString(), user.email);
                    return {
                        id: user._id.toString(),
                        name: user.name,
                        email: user.email,
                        image: user.avatarUrl,
                        role: user.role
                    };
                } catch (error) {
                    console.error("[Authorize] Unexpected error:", error.message, error.stack);
                    // Re-throw specific known errors for NextAuth to handle and potentially display to user
                    if ([
                        "No user found with this email.",
                        "Invalid password.",
                        "User account is not properly configured for password login.",
                        "Please enter both email and password."
                    ].includes(error.message) || error.message.startsWith("Database connection failed:") || error.message.startsWith("Server configuration error:")) {
                        throw error;
                    }
                    // For other unexpected errors, throw a generic message
                    throw new Error("Authentication failed due to an unexpected server issue. Please try again.");
                }
            }
        })
    ],
    // === Session Configuration ===
    session: {
        strategy: "jwt"
    },
    // === Callback Functions ===
    callbacks: {
        // Modify JWT on login or session update
        async jwt ({ token, user, trigger, session: newSessionData }) {
            try {
                // On initial sign in, the `user` object from `authorize` is available
                if (user) {
                    console.log("[JWT Callback] Initial user object from authorize:", user);
                    token.id = user.id;
                    token.name = user.name;
                    token.email = user.email;
                    token.picture = user.image; // `user.image` from authorize maps to `token.picture`
                    token.role = user.role;
                }
                // Handle session updates (e.g., user updates profile)
                if (trigger === "update" && newSessionData?.user) {
                    console.log("[JWT Callback] Updating token from session update data:", newSessionData.user);
                    token.name = newSessionData.user.name;
                    token.email = newSessionData.user.email;
                    token.picture = newSessionData.user.image;
                    token.role = newSessionData.user.role;
                }
                console.log("[JWT Callback] Token before returning:", token);
                return token;
            } catch (error) {
                console.error("[JWT Callback] Error in JWT callback:", error.message, error.stack);
                // Return existing token or throw to signify critical failure.
                // Returning existing token might lead to inconsistent state if update failed.
                // For now, returning token to prevent complete session breakage if possible.
                return token;
            }
        },
        // Attach token data to session for use on client side
        async session ({ session, token }) {
            try {
                console.log("[Session Callback] Token received:", token);
                if (token) {
                    // Ensure session.user exists and is structured according to `next-auth.d.ts`
                    session.user = {
                        id: token.id,
                        name: token.name,
                        email: token.email,
                        image: token.picture,
                        role: token.role
                    };
                }
                console.log("[Session Callback] Session user before returning:", session.user);
                return session;
            } catch (error) {
                console.error("[Session Callback] Error in session callback:", error.message, error.stack);
                // Return existing session to prevent complete breakage if possible.
                return session;
            }
        }
    },
    // === Custom Auth Pages ===
    pages: {
        signIn: "/login",
        error: "/login"
    },
    // === Secret for signing JWT ===
    secret: process.env.NEXTAUTH_SECRET
};
// Export for Next.js API routes
const handler = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])(authOptions);
;
}}),
"[project]/src/models/Booking.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "default": (()=>__TURBOPACK__default__export__)
});
var __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/mongoose [external] (mongoose, cjs)");
;
const bookingSchema = new __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["Schema"]({
    listingId: {
        type: __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["Schema"].Types.ObjectId,
        ref: 'Property',
        required: true
    },
    guestId: {
        type: __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["Schema"].Types.ObjectId,
        ref: 'User',
        required: true
    },
    startDate: {
        type: Date,
        required: true
    },
    endDate: {
        type: Date,
        required: true
    },
    totalPrice: {
        type: Number,
        required: true,
        min: 0
    },
    paymentStatus: {
        type: String,
        enum: [
            'pending',
            'paid',
            'failed',
            'refunded'
        ],
        required: true,
        default: 'pending'
    },
    bookingStatus: {
        type: String,
        enum: [
            'pending_confirmation',
            'pending_payment',
            'confirmed_by_host',
            'rejected_by_host',
            'cancelled_by_guest',
            'cancelled_by_admin',
            'completed',
            'no_show'
        ],
        required: true,
        default: 'pending_confirmation'
    }
}, {
    timestamps: true
});
bookingSchema.index({
    listingId: 1,
    startDate: 1,
    endDate: 1
});
bookingSchema.index({
    guestId: 1
});
const __TURBOPACK__default__export__ = __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].models.Booking || __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].model("Booking", bookingSchema);
}}),
"[project]/src/models/Property.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "default": (()=>__TURBOPACK__default__export__)
});
var __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/mongoose [external] (mongoose, cjs)");
;
const propertySchema = new __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["Schema"]({
    hostId: {
        type: __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["Schema"].Types.ObjectId,
        ref: 'User',
        required: true
    },
    title: {
        type: String,
        required: true,
        trim: true
    },
    description: {
        type: String,
        required: true
    },
    price: {
        type: Number,
        required: true,
        min: 0
    },
    pricePeriod: {
        type: String,
        enum: [
            'nightly',
            'weekly',
            'monthly'
        ],
        required: true,
        default: 'nightly'
    },
    location: {
        type: String,
        required: true,
        trim: true
    },
    address: {
        type: String,
        trim: true
    },
    maxGuests: {
        type: Number,
        required: true,
        min: 1
    },
    images: {
        type: [
            String
        ],
        validate: {
            validator: function(v) {
                return v == null || v.length === 0 || v.every((url)=>typeof url === 'string' && url.startsWith('http'));
            },
            message: 'All image entries must be valid URLs.'
        },
        default: []
    },
    bedrooms: {
        type: Number,
        required: true,
        min: 0
    },
    bathrooms: {
        type: Number,
        required: true,
        min: 0
    },
    amenities: {
        type: [
            String
        ],
        default: []
    },
    type: {
        type: String,
        enum: [
            'House',
            'Apartment',
            'Room',
            'Unique Stay'
        ],
        required: true
    },
    host: {
        name: {
            type: String,
            required: true
        },
        avatarUrl: {
            type: String
        }
    },
    rating: {
        type: Number,
        min: 0,
        max: 5
    },
    reviewsCount: {
        type: Number,
        min: 0,
        default: 0
    },
    availableFrom: {
        type: Date,
        required: false
    },
    availableTo: {
        type: Date,
        required: false
    }
}, {
    timestamps: true,
    toJSON: {
        virtuals: true,
        transform: function(doc, ret) {
            ret.id = ret._id.toString();
            delete ret._id;
            delete ret.__v;
            if (ret.hostId instanceof __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].Types.ObjectId) {
                ret.hostId = ret.hostId.toString();
            }
        // Transformation for bookedDateRanges is removed
        }
    },
    toObject: {
        virtuals: true,
        transform: function(doc, ret) {
            ret.id = ret._id.toString();
            delete ret._id;
            delete ret.__v;
            if (ret.hostId instanceof __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].Types.ObjectId) {
                ret.hostId = ret.hostId.toString();
            }
        // Transformation for bookedDateRanges is removed
        }
    }
});
propertySchema.index({
    location: 'text',
    title: 'text',
    description: 'text'
});
propertySchema.index({
    hostId: 1
});
propertySchema.index({
    createdAt: -1
});
const __TURBOPACK__default__export__ = __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].models.Property || __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].model("Property", propertySchema);
}}),
"[project]/src/models/BookedDateRange.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "default": (()=>__TURBOPACK__default__export__)
});
var __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/mongoose [external] (mongoose, cjs)");
;
const bookedDateRangeSchema = new __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["Schema"]({
    propertyId: {
        type: __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["Schema"].Types.ObjectId,
        ref: 'Property',
        required: true,
        index: true
    },
    bookingId: {
        type: __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["Schema"].Types.ObjectId,
        ref: 'Booking',
        required: true,
        unique: true,
        index: true
    },
    startDate: {
        type: Date,
        required: true
    },
    endDate: {
        type: Date,
        required: true
    },
    status: {
        type: String,
        enum: [
            'pending_confirmation',
            'pending_payment',
            'confirmed_by_host',
            'rejected_by_host',
            'cancelled_by_guest',
            'cancelled_by_admin',
            'completed',
            'no_show'
        ],
        required: true,
        index: true
    }
}, {
    timestamps: true
});
// Compound index to quickly find overlapping ranges for a property
bookedDateRangeSchema.index({
    propertyId: 1,
    startDate: 1,
    endDate: 1
});
bookedDateRangeSchema.index({
    propertyId: 1,
    status: 1
});
const __TURBOPACK__default__export__ = __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].models.BookedDateRange || __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].model("BookedDateRange", bookedDateRangeSchema);
}}),
"[externals]/fs [external] (fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/dns [external] (dns, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("dns", () => require("dns"));

module.exports = mod;
}}),
"[externals]/os [external] (os, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}}),
"[externals]/path [external] (path, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[project]/src/utils/mailer.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "sendEmail": (()=>sendEmail)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/nodemailer/lib/nodemailer.js [app-route] (ecmascript)");
;
// Hardcoded Gmail credentials for testing
const GOOGLE_EMAIL = "pacbot24@gmail.com";
const GOOGLE_PASSWORD = "ofzyqssefycvpawh"; // This appears to be an App Password
let transporterInstance = null;
let mailerConfigError = null;
if ("TURBOPACK compile-time falsy", 0) {
    "TURBOPACK unreachable";
} else {
    transporterInstance = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$nodemailer$2f$lib$2f$nodemailer$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].createTransport({
        service: 'gmail',
        auth: {
            user: GOOGLE_EMAIL,
            pass: GOOGLE_PASSWORD
        }
    });
    // Verify connection configuration during setup
    transporterInstance.verify((error, success)=>{
        if (error) {
            mailerConfigError = `Mailer (Gmail) configuration error during verification: ${error.message}. Emails may not be sent.`;
            console.error(`[Mailer] ${mailerConfigError}`);
            transporterInstance = null; // Invalidate transporter if verification fails
        } else {
            console.log('[Mailer] Gmail email service is configured with hardcoded credentials and ready to send emails.');
        }
    });
}
const sendEmail = async (options)=>{
    if (mailerConfigError || !transporterInstance) {
        const errorMessage = mailerConfigError || "Mailer (Gmail) not initialized or verification failed.";
        console.warn(`[Mailer] Attempted to send email but Gmail mailer is not properly configured. Subject: "${options.subject}", To: "${options.to}"`);
        console.warn(`[Mailer] Configuration Error: ${errorMessage}`);
        return {
            success: false,
            error: errorMessage
        };
    }
    try {
        const info = await transporterInstance.sendMail({
            from: `"${process.env.APP_NAME || 'Lodger App'}" <${GOOGLE_EMAIL}>`,
            to: options.to,
            subject: options.subject,
            text: options.text,
            html: options.html
        });
        console.log(`[Mailer] Email sent successfully via Gmail. Subject: "${options.subject}", To: "${options.to}", Message ID: ${info.messageId}`);
        return {
            success: true,
            messageId: info.messageId
        };
    } catch (error) {
        let specificError = error.message;
        if (error.code === 'EAUTH' || error.responseCode && error.responseCode === 535) {
            specificError = "Authentication failed with Gmail. Check your hardcoded GOOGLE_EMAIL and GOOGLE_PASSWORD. Ensure 'Less secure app access' is handled appropriately if not using an App Password (not recommended for regular passwords).";
            console.error(`[Mailer] Gmail Authentication Error: ${specificError}`);
        } else {
            console.error(`[Mailer] Error sending email via Gmail. Subject: "${options.subject}", To: "${options.to}"`, error);
        }
        return {
            success: false,
            error: specificError
        };
    }
};
}}),
"[project]/src/app/api/bookings/initiate-payment/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
/* __next_internal_action_entry_do_not_use__ [{"40d7692557b5114262889ed4d9309bae7ec3eb26f6":"POST"},"",""] */ __turbopack_context__.s({
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/server-reference.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$server$2f$app$2d$render$2f$encryption$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/server/app-render/encryption.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$next$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/next/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$stripe$2f$esm$2f$stripe$2e$esm$2e$node$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/stripe/esm/stripe.esm.node.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$app$2f$api$2f$auth$2f5b2e2e2e$nextauth$5d2f$route$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/app/api/auth/[...nextauth]/route.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$utils$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/utils/db.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$Booking$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/models/Booking.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$Property$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/models/Property.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$BookedDateRange$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/models/BookedDateRange.ts [app-route] (ecmascript)"); // Import new model
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$User$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/models/User.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/zod/lib/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$differenceInCalendarDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/differenceInCalendarDays.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfDay$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/startOfDay.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/date-fns/format.mjs [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$utils$2f$mailer$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/utils/mailer.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/mongoose [external] (mongoose, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/dist/build/webpack/loaders/next-flight-loader/action-validate.js [app-route] (ecmascript)");
;
;
;
;
;
;
;
;
;
;
;
;
;
;
;
const STRIPE_SECRET_KEY = process.env.STRIPE_SECRET_KEY;
const stripe = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$stripe$2f$esm$2f$stripe$2e$esm$2e$node$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"](STRIPE_SECRET_KEY, {
    apiVersion: '2024-04-10'
});
const initiatePaymentSchema = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["object"])({
    propertyId: (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["string"])().refine((val)=>/^[0-9a-fA-F]{24}$/.test(val), {
        message: "Invalid property ID format."
    }),
    startDate: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["coerce"].date().refine((date)=>date >= (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfDay$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["startOfDay"])(new Date()), {
        message: "Start date cannot be in the past."
    }),
    endDate: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["coerce"].date()
}).refine((data)=>data.endDate > data.startDate, {
    message: "End date must be after start date.",
    path: [
        "endDate"
    ]
});
const APP_URL = process.env.NEXTAUTH_URL || 'http://localhost:9002'; // Use NEXTAUTH_URL with a fallback
async function POST(request) {
    try {
        const session = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$next$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getServerSession"])(__TURBOPACK__imported__module__$5b$project$5d2f$src$2f$app$2f$api$2f$auth$2f5b2e2e2e$nextauth$5d2f$route$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["authOptions"]);
        if (!session || !session.user || !session.user.id || !session.user.email) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Unauthorized: You must be logged in and have an email address.'
            }, {
                status: 401
            });
        }
        const guestId = session.user.id;
        const guestEmail = session.user.email;
        const guestName = session.user.name || 'Valued Guest';
        const body = await request.json();
        const parsedBody = initiatePaymentSchema.safeParse(body);
        if (!parsedBody.success) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Invalid data provided.',
                errors: parsedBody.error.format()
            }, {
                status: 400
            });
        }
        const { propertyId, startDate, endDate } = parsedBody.data;
        const normalizedStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfDay$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["startOfDay"])(startDate);
        const normalizedEndDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfDay$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["startOfDay"])(endDate);
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$utils$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])();
        let property = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$Property$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].findById(propertyId);
        if (!property) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Property not found.'
            }, {
                status: 404
            });
        }
        if (property.hostId.toString() === guestId) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Hosts cannot book their own properties.'
            }, {
                status: 403
            });
        }
        if (property.availableFrom && normalizedStartDate < (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfDay$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["startOfDay"])(new Date(property.availableFrom))) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Booking start date is before property availability window.'
            }, {
                status: 400
            });
        }
        if (property.availableTo && normalizedEndDate > (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfDay$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["startOfDay"])(new Date(property.availableTo))) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Booking end date is after property availability window.'
            }, {
                status: 400
            });
        }
        // Check for conflicting BookedDateRange documents
        const conflictingRangeDoc = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$BookedDateRange$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].findOne({
            propertyId: new __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].Types.ObjectId(propertyId),
            status: {
                $in: [
                    'confirmed_by_host',
                    'pending_confirmation',
                    'pending_payment'
                ]
            },
            startDate: {
                $lt: normalizedEndDate
            },
            endDate: {
                $gt: normalizedStartDate
            }
        });
        if (conflictingRangeDoc) {
            console.log("[API /bookings/initiate-payment POST] Conflict found with existing BookedDateRange document:", conflictingRangeDoc._id.toString(), "Status:", conflictingRangeDoc.status);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'These dates are no longer available for this property. Please choose different dates.'
            }, {
                status: 409
            });
        }
        let numberOfUnits = 0;
        if (property.pricePeriod === 'nightly') {
            numberOfUnits = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$differenceInCalendarDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["differenceInCalendarDays"])(normalizedEndDate, normalizedStartDate);
            if (numberOfUnits === 0 && normalizedStartDate.getTime() === normalizedEndDate.getTime()) {
                numberOfUnits = 1;
            }
        } else if (property.pricePeriod === 'weekly') {
            numberOfUnits = Math.max(1, Math.ceil((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$differenceInCalendarDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["differenceInCalendarDays"])(normalizedEndDate, normalizedStartDate) / 7));
        } else if (property.pricePeriod === 'monthly') {
            numberOfUnits = Math.max(1, Math.ceil((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$differenceInCalendarDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["differenceInCalendarDays"])(normalizedEndDate, normalizedStartDate) / 30));
        }
        if (numberOfUnits <= 0) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Booking duration is invalid for the selected price period.'
            }, {
                status: 400
            });
        }
        const totalPrice = property.price * numberOfUnits;
        const newBooking = new __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$Booking$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"]({
            listingId: property._id,
            guestId: new __TURBOPACK__imported__module__$5b$externals$5d2f$mongoose__$5b$external$5d$__$28$mongoose$2c$__cjs$29$__["default"].Types.ObjectId(guestId),
            startDate: normalizedStartDate,
            endDate: normalizedEndDate,
            totalPrice,
            paymentStatus: 'pending',
            bookingStatus: 'pending_confirmation'
        });
        await newBooking.save();
        console.log("[API /bookings/initiate-payment POST] New booking created with 'pending_confirmation' status:", newBooking._id.toString());
        // Create a new BookedDateRange document
        const newBookedDateRange = new __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$BookedDateRange$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"]({
            propertyId: property._id,
            bookingId: newBooking._id,
            startDate: newBooking.startDate,
            endDate: newBooking.endDate,
            status: 'pending_confirmation'
        });
        await newBookedDateRange.save();
        console.log(`[API /bookings/initiate-payment POST] New BookedDateRange document created: ${newBookedDateRange._id.toString()} for booking ${newBooking._id.toString()} with 'pending_confirmation' status.`);
        const stripeSession = await stripe.checkout.sessions.create({
            payment_method_types: [
                'card'
            ],
            line_items: [
                {
                    price_data: {
                        currency: 'usd',
                        product_data: {
                            name: `${property.title} (Booking: ${newBooking._id.toString()})`,
                            description: `Stay from ${(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(normalizedStartDate, 'MMM dd, yyyy')} to ${(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(normalizedEndDate, 'MMM dd, yyyy')}. Property ID: ${propertyId}`,
                            images: property.images && property.images.length > 0 ? [
                                property.images[0]
                            ] : undefined
                        },
                        unit_amount: Math.round(totalPrice * 100)
                    },
                    quantity: 1
                }
            ],
            mode: 'payment',
            success_url: `${APP_URL}/booking/success?session_id={CHECKOUT_SESSION_ID}&booking_id=${newBooking._id.toString()}`,
            cancel_url: `${APP_URL}/booking/cancel?booking_id=${newBooking._id.toString()}&property_id=${propertyId}`,
            client_reference_id: newBooking._id.toString(),
            metadata: {
                bookingId: newBooking._id.toString(),
                propertyId: propertyId,
                guestId: guestId
            },
            customer_email: guestEmail
        });
        if (!stripeSession.id) {
            console.warn("[API /bookings/initiate-payment POST] Stripe session creation failed. Deleting temporary booking and booked date range:", newBooking._id.toString());
            await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$Booking$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].findByIdAndDelete(newBooking._id);
            await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$BookedDateRange$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].findOneAndDelete({
                bookingId: newBooking._id
            });
            console.warn(`[API /bookings/initiate-payment POST] Cleaned up booking ${newBooking._id.toString()} and associated BookedDateRange due to Stripe failure.`);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                message: 'Failed to initiate payment session with provider.'
            }, {
                status: 500
            });
        }
        console.log("[API /bookings/initiate-payment POST] Stripe session created:", stripeSession.id, "for booking:", newBooking._id.toString());
        const formattedStartDateString = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(normalizedStartDate, 'MMMM dd, yyyy');
        const formattedEndDateString = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(normalizedEndDate, 'MMMM dd, yyyy');
        // Email to Guest: Informing them payment is pending, but booking request is now with host.
        const guestEmailResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$utils$2f$mailer$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["sendEmail"])({
            to: guestEmail,
            subject: `Your Booking Request for ${property.title} is Awaiting Host Confirmation`,
            text: `Hi ${guestName},\n\nYour booking request for "${property.title}" from ${formattedStartDateString} to ${formattedEndDateString} for a total of $${totalPrice.toFixed(2)} is now awaiting host confirmation. Payment is still pending.\n\nYou should have been redirected to Stripe to finalize your payment. If not, please check your browser or contact support. Your booking is not fully confirmed until payment is successful AND the host accepts your request.\n\nBooking ID: ${newBooking._id.toString()}\n\nThank you,\nThe Lodger Team`,
            html: `<p>Hi ${guestName},</p><p>Your booking request for <strong>"${property.title}"</strong> from <strong>${formattedStartDateString}</strong> to <strong>${formattedEndDateString}</strong> for a total of <strong>$${totalPrice.toFixed(2)}</strong> is now awaiting host confirmation. Payment is still pending.</p><p>You should have been redirected to Stripe to finalize your payment. If not, please check your browser or contact support. Your booking is not fully confirmed until payment is successful AND the host accepts your request.</p><p>Booking ID: ${newBooking._id.toString()}</p><p>Thank you,<br/>The Lodger Team</p>`
        });
        if (guestEmailResult.success) {
            console.log(`[API /bookings/initiate-payment POST] Booking request (pending payment & host confirmation) email sent to guest ${guestEmail} for booking ${newBooking._id.toString()}`);
        } else {
            console.warn(`[API /bookings/initiate-payment POST] Failed to send booking request email to guest ${guestEmail} for booking ${newBooking._id.toString()}. Error: ${guestEmailResult.error}`);
        }
        // Email to Host: Informing them of a new booking request that is pending guest payment and their confirmation.
        const hostUser = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$models$2f$User$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].findById(property.hostId).lean();
        if (hostUser && hostUser.email) {
            const hostEmailResult = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$utils$2f$mailer$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["sendEmail"])({
                to: hostUser.email,
                subject: `New Booking Request for ${property.title} (Awaiting Guest Payment & Your Confirmation)`,
                text: `Hi ${hostUser.name || 'Host'},\n\nA guest (${guestName}, ${guestEmail}) has requested to book your property "${property.title}" for the dates ${formattedStartDateString} to ${formattedEndDateString}.\n\nThe guest is currently being directed to complete payment. Once payment is successful, the booking will await your confirmation in your dashboard. Please review this request in your dashboard.\n\nBooking ID: ${newBooking._id.toString()}\nProperty ID: ${property.id}\n\nRegards,\nThe Lodger Team`,
                html: `<p>Hi ${hostUser.name || 'Host'},</p><p>A guest (<strong>${guestName}</strong>, ${guestEmail}) has requested to book your property "<strong>${property.title}</strong>" for the dates <strong>${formattedStartDateString}</strong> to <strong>${formattedEndDateString}</strong>.</p><p>The guest is currently being directed to complete payment. Once payment is successful, the booking will await your confirmation in your dashboard. Please review this request in your dashboard.</p><p>Booking ID: ${newBooking._id.toString()}<br/>Property ID: ${property.id}</p><p>Regards,<br/>The Lodger Team</p>`
            });
            if (hostEmailResult.success) {
                console.log(`[API /bookings/initiate-payment POST] New booking request notification (pending payment & host confirmation) sent to host ${hostUser.email} for booking ${newBooking._id.toString()}`);
            } else {
                console.warn(`[API /bookings/initiate-payment POST] Failed to send new booking request notification to host ${hostUser.email} for booking ${newBooking._id.toString()}. Error: ${hostEmailResult.error}`);
            }
        } else {
            console.warn(`[API /bookings/initiate-payment POST] Could not find host email for property ${property.id} to send new booking request notification. Host ID: ${property.hostId}`);
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            sessionId: stripeSession.id
        }, {
            status: 200
        });
    } catch (error) {
        console.error('[API /bookings/initiate-payment POST] Error:', error);
        let errorMessage = 'An unexpected error occurred.';
        if (error.name === 'MongoNetworkError') {
            errorMessage = 'Database connection error.';
        } else if (error.message) {
            errorMessage = error.message;
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            message: errorMessage,
            errorDetails: error.toString()
        }, {
            status: 500
        });
    }
}
;
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$action$2d$validate$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["ensureServerEntryExports"])([
    POST
]);
(0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$dist$2f$build$2f$webpack$2f$loaders$2f$next$2d$flight$2d$loader$2f$server$2d$reference$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["registerServerReference"])(POST, "40d7692557b5114262889ed4d9309bae7ec3eb26f6", null);
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__acc38119._.js.map